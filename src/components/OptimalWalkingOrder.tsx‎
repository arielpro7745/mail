import { useState } from 'react';
import {
  Navigation2, MapPin, Clock, ChevronDown, ChevronUp,
  Navigation, CheckCircle2, Circle, ArrowDown
} from 'lucide-react';
import { useDistribution } from '../hooks/useDistribution';
import { getAreaColor, getAreaName } from '../utils/areaColors';
import { streets } from '../data/streets';
import { Street, Area } from '../types';

// סדר הליכה אופטימלי לפתח תקווה - מבוסס על מיקום גיאוגרפי
const optimalWalkOrders: Record<number, { id: string; notes: string; estimatedMinutes: number }[]> = {
  12: [
    { id: "david-zvi-pinkas-1-21", notes: "התחלה - כניסה לאזור מצד דרום", estimatedMinutes: 8 },
    { id: "david-zvi-pinkas-24-2", notes: "המשך באותו רחוב - צד שני", estimatedMinutes: 8 },
    { id: "ninety-three-42-2", notes: "פניה ימינה להתשעים ושלוש", estimatedMinutes: 7 },
    { id: "ninety-three-1-11", notes: "המשך באותו רחוב", estimatedMinutes: 6 },
    { id: "ninety-three-13-21", notes: "סיום התשעים ושלוש", estimatedMinutes: 6 },
    { id: "hakerem", notes: "פניה לרחוב הכרם - קרוב", estimatedMinutes: 5 },
    { id: "harav-kook", notes: "המשך צפונה להרב קוק", estimatedMinutes: 7 },
    { id: "zichron-moshe", notes: "פניה לזכרון משה", estimatedMinutes: 6 },
    { id: "anna-frank", notes: "המשך לאנה פרנק - סמוך", estimatedMinutes: 5 },
    { id: "chaim-cohen", notes: "פניה לחיים כהן", estimatedMinutes: 6 },
    { id: "chafetz-mordechai", notes: "המשך לחפץ מרדכי", estimatedMinutes: 5 },
    { id: "mendelson", notes: "פניה למנדלסון", estimatedMinutes: 6 },
    { id: "haachim-raab", notes: "המשך להאחים ראב", estimatedMinutes: 5 },
    { id: "sweden", notes: "סיום - רחוב שבדיה", estimatedMinutes: 5 }
  ],
  14: [
    { id: "d-hayomi", notes: "התחלה - הדף היומי (נקודת כניסה)", estimatedMinutes: 6 },
    { id: "rot-110‑132", notes: "כניסה לרוטשילד מצד מזרח", estimatedMinutes: 10 },
    { id: "rot-134‑150", notes: "המשך ברוטשילד צפונה", estimatedMinutes: 8 },
    { id: "rot-152‑182", notes: "רוטשילד גדול - לקחת זמן", estimatedMinutes: 15 },
    { id: "gad-machnes-4", notes: "סטייה קצרה לגד מכנס", estimatedMinutes: 5 },
    { id: "rot-179‑143", notes: "חזרה לרוטשילד - צד שני", estimatedMinutes: 12 },
    { id: "rot-141‑109", notes: "המשך רוטשילד דרומה", estimatedMinutes: 10 },
    { id: "kkl-even", notes: "מעבר לקק\"ל - זוגי", estimatedMinutes: 7 },
    { id: "kkl-odd", notes: "סיום - קק\"ל אי-זוגי", estimatedMinutes: 7 }
  ],
  45: [
    { id: "yatk-32‑42", notes: "התחלה - יטקובסקי זוגי", estimatedMinutes: 7 },
    { id: "yatk-37‑25", notes: "המשך יטקובסקי - צד שני", estimatedMinutes: 7 },
    { id: "weiz-even", notes: "מעבר לויצמן - רחוב גדול!", estimatedMinutes: 18 },
    { id: "weiz-odd", notes: "ויצמן צד שני - גדול!", estimatedMinutes: 18 },
    { id: "dagel-even", notes: "פניה לדגל ראובן", estimatedMinutes: 12 },
    { id: "dagel-odd", notes: "דגל ראובן - צד שני", estimatedMinutes: 12 },
    { id: "heib-even", notes: "מעבר להיבנר", estimatedMinutes: 15 },
    { id: "heib-odd", notes: "היבנר - צד שני", estimatedMinutes: 12 },
    { id: "bertonov", notes: "ברטונוב - רחוב גדול", estimatedMinutes: 20 },
    { id: "martin-buber", notes: "פניה למרטין בובר", estimatedMinutes: 6 },
    { id: "partisans", notes: "המשך להפרטיזנים", estimatedMinutes: 5 },
    { id: "lisin", notes: "ליסין - קרוב", estimatedMinutes: 5 },
    { id: "mirkin", notes: "מירקין", estimatedMinutes: 5 },
    { id: "senerov", notes: "סנרוב", estimatedMinutes: 5 },
    { id: "stern", notes: "סיום - שטרן", estimatedMinutes: 5 }
  ]
};

export default function OptimalWalkingOrder() {
  const [expanded, setExpanded] = useState(true);
  const { todayArea, pendingToday, markDelivered } = useDistribution();

  const areaColor = getAreaColor(todayArea);
  const walkOrder = optimalWalkOrders[todayArea] || [];

  // מיפוי הרחובות עם מידע על סטטוס
  const orderedStreets = walkOrder.map(item => {
    const street = streets.find(s => s.id === item.id);
    const isPending = pendingToday.some(s => s.id === item.id);
    return {
      ...item,
      street,
      isPending,
      isCompleted: !isPending && street !== undefined
    };
  }).filter(item => item.street);

  const totalTime = orderedStreets.reduce((sum, item) => sum + item.estimatedMinutes, 0);
  const completedCount = orderedStreets.filter(s => s.isCompleted).length;
  const remainingTime = orderedStreets
    .filter(s => s.isPending)
    .reduce((sum, item) => sum + item.estimatedMinutes, 0);

  // מצא את הרחוב הבא
  const nextStreetIndex = orderedStreets.findIndex(s => s.isPending);

  return (
    <div className="bg-white rounded-2xl shadow-lg border border-gray-100 overflow-hidden mb-6">
      {/* כותרת */}
      <button
        onClick={() => setExpanded(!expanded)}
        className={`w-full ${areaColor.bgSolid} px-5 py-4 text-white flex items-center justify-between`}
      >
        <div className="flex items-center gap-3">
          <div className="w-10 h-10 bg-white/20 rounded-xl flex items-center justify-center">
            <Navigation2 size={22} />
          </div>
          <div className="text-right">
            <h3 className="font-bold text-lg">סדר הליכה מומלץ - אזור {todayArea}</h3>
            <p className="text-sm opacity-90">{getAreaName(todayArea)} • פתח תקווה</p>
          </div>
        </div>

        <div className="flex items-center gap-4">
          <div className="text-right hidden sm:block">
            <p className="text-sm opacity-75">זמן משוער שנותר</p>
            <p className="font-bold">{Math.floor(remainingTime / 60)}:{(remainingTime % 60).toString().padStart(2, '0')} שעות</p>
          </div>
          {expanded ? <ChevronUp size={24} /> : <ChevronDown size={24} />}
        </div>
      </button>

      {expanded && (
        <div className="p-5">
          {/* סטטיסטיקות */}
          <div className="grid grid-cols-3 gap-4 mb-6">
            <div className="bg-gray-50 rounded-xl p-4 text-center">
              <p className="text-2xl font-bold text-gray-800">{orderedStreets.length}</p>
              <p className="text-sm text-gray-500">סה"כ רחובות</p>
            </div>
            <div className="bg-green-50 rounded-xl p-4 text-center">
              <p className="text-2xl font-bold text-green-600">{completedCount}</p>
              <p className="text-sm text-gray-500">הושלמו</p>
            </div>
            <div className="bg-orange-50 rounded-xl p-4 text-center">
              <p className="text-2xl font-bold text-orange-600">{orderedStreets.length - completedCount}</p>
              <p className="text-sm text-gray-500">נותרו</p>
            </div>
          </div>

          {/* רשימת רחובות */}
          <div className="space-y-2">
            {orderedStreets.map((item, index) => {
              const isNext = index === nextStreetIndex;

              return (
                <div
                  key={item.id}
                  className={`
                    relative flex items-center gap-4 p-4 rounded-xl border-2 transition-all
                    ${item.isCompleted
                      ? 'bg-green-50 border-green-200 opacity-60'
                      : isNext
                        ? `${areaColor.bg} ${areaColor.border} ring-2 ring-offset-2 ${areaColor.ring}`
                        : 'bg-gray-50 border-gray-200'
                    }
                  `}
                >
                  {/* מספר סידורי */}
                  <div className={`
                    w-10 h-10 rounded-full flex items-center justify-center font-bold text-lg
                    ${item.isCompleted
                      ? 'bg-green-500 text-white'
                      : isNext
                        ? `${areaColor.bgSolid} text-white`
                        : 'bg-gray-200 text-gray-600'
                    }
                  `}>
                    {item.isCompleted ? <CheckCircle2 size={20} /> : index + 1}
                  </div>

                  {/* פרטי רחוב */}
                  <div className="flex-1">
                    <div className="flex items-center gap-2">
                      <h4 className={`font-bold ${item.isCompleted ? 'text-green-700 line-through' : 'text-gray-800'}`}>
                        {item.street?.name}
                      </h4>
                      {item.street?.isBig && (
                        <span className="bg-orange-100 text-orange-700 text-xs px-2 py-0.5 rounded-full">
                          רחוב גדול
                        </span>
                      )}
                      {isNext && (
                        <span className={`${areaColor.bgSolid} text-white text-xs px-2 py-0.5 rounded-full animate-pulse`}>
                          הבא!
                        </span>
                      )}
                    </div>
                    <p className="text-sm text-gray-500 flex items-center gap-2">
                      <Navigation size={12} />
                      {item.notes}
                    </p>
                  </div>

                  {/* זמן וכפתור */}
                  <div className="flex items-center gap-3">
                    <div className="text-right">
                      <div className="flex items-center gap-1 text-gray-500">
                        <Clock size={14} />
                        <span className="text-sm">{item.estimatedMinutes} דק'</span>
                      </div>
                    </div>

                    {item.isPending && (
                      <button
                        onClick={() => markDelivered(item.id)}
                        className={`
                          px-4 py-2 rounded-lg font-medium text-sm transition-all
                          ${isNext
                            ? `${areaColor.bgSolid} text-white hover:opacity-90`
                            : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                          }
                        `}
                      >
                        סמן כהושלם
                      </button>
                    )}
                  </div>

                  {/* קו מחבר */}
                  {index < orderedStreets.length - 1 && (
                    <div className="absolute left-[2.25rem] -bottom-2 w-0.5 h-4 bg-gray-200" />
                  )}
                </div>
              );
            })}
          </div>

          {/* כפתור ניווט */}
          {nextStreetIndex >= 0 && orderedStreets[nextStreetIndex]?.street && (
            <div className="mt-6 p-4 bg-gradient-to-r from-blue-50 to-indigo-50 rounded-xl border border-blue-200">
              <p className="text-sm text-blue-800 mb-3 font-medium">
                נווט לרחוב הבא: {orderedStreets[nextStreetIndex].street?.name}
              </p>
              <div className="flex gap-3">
                <a
                  href={`https://waze.com/ul?q=${encodeURIComponent(orderedStreets[nextStreetIndex].street?.name + ' פתח תקווה')}`}
                  target="_blank"
                  rel="noopener noreferrer"
                  className="flex-1 flex items-center justify-center gap-2 px-4 py-3 bg-blue-500 hover:bg-blue-600 text-white rounded-lg font-medium transition-colors"
                >
                  <Navigation size={18} />
                  Waze
                </a>
                <a
                  href={`https://www.google.com/maps/search/${encodeURIComponent(orderedStreets[nextStreetIndex].street?.name + ' פתח תקווה')}`}
                  target="_blank"
                  rel="noopener noreferrer"
                  className="flex-1 flex items-center justify-center gap-2 px-4 py-3 bg-green-500 hover:bg-green-600 text-white rounded-lg font-medium transition-colors"
                >
                  <MapPin size={18} />
                  Google Maps
                </a>
              </div>
            </div>
          )}
        </div>
      )}
    </div>
  );
}